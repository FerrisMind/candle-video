# SVD Diffusers Parity - –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: 71% (17/24 –ø–æ–¥–∑–∞–¥–∞—á)

## –û–±–∑–æ—Ä –ø–æ–¥—Ö–æ–¥–∞

–†–µ–∞–ª–∏–∑—É–µ–º –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 100% –ø–∞—Ä–∏—Ç–µ—Ç–∞ —Å diffusers pipeline. –ù–∞—á–∏–Ω–∞–µ–º —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤ (FPS conditioning, timestep scaling), –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º (guidance scale per-frame, noise augmentation). –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å diffusers output. –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ–º –æ–±—ä—ë–º –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî —Ñ–∏–∫—Å–∏–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å.

## –ó–∞–¥–∞—á–∏

### 1. FPS Conditioning Fix ‚úÖ
**–¶–µ–ª—å:** SVD –æ–±—É—á–µ–Ω –Ω–∞ `fps-1`, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É FPS –≤ time embeddings
**–§–∞–π–ª—ã:** `src/svd/pipeline.rs`

- [x] 1.1: –ò–∑–º–µ–Ω–∏—Ç—å `config.fps as f32` –Ω–∞ `(config.fps.saturating_sub(1)) as f32` –≤ added_time_ids
- [x] 1.2: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ diffusers source

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ `cargo build` –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –í added_time_ids –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è fps-1

---

### 2. Timestep Scaling Fix ‚úÖ
**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 0.25 –¥–ª—è continuous timestep type (–∫–∞–∫ –≤ diffusers)
**–§–∞–π–ª—ã:** `src/svd/scheduler.rs`

- [x] 2.1: –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É –≤ `set_timesteps` —Å `-ln(sigma)` –Ω–∞ `0.25 * ln(sigma)`
- [x] 2.2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å `scheduling_euler_discrete.py:255`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ Timesteps —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç diffusers –ø—Ä–∏ —Ç–µ—Ö –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
- ‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç

---

### 3. Noise Augmentation Order ‚úÖ
**–¶–µ–ª—å:** –î–æ–±–∞–≤–ª—è—Ç—å noise –∫ image –≤ pixel space –ü–ï–†–ï–î encode (–∫–∞–∫ –≤ diffusers)
**–§–∞–π–ª—ã:** `src/svd/pipeline.rs`
**–ó–∞–≤–∏—Å–∏—Ç –æ—Ç:** –ó–∞–¥–∞—á–∞ 1

- [x] 3.1: –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ noise augmentation –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `vae.encode_to_latent`
- [x] 3.2: –£–¥–∞–ª–∏—Ç—å noise augmentation –ø–æ—Å–ª–µ encode
- [x] 3.3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Tensor::randn_like()` –¥–ª—è image tensor

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ Noise –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ image tensor [B, 3, H, W] –ø–µ—Ä–µ–¥ encode
- ‚úÖ `image_latents` –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ encode

---

### 4. Per-Frame Guidance Scale ‚úÖ
**–¶–µ–ª—å:** Guidance scale –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ—Ç—Å—è –ø–æ —Ñ—Ä–µ–π–º–∞–º (–∫–∞–∫ –≤ diffusers), –Ω–µ –ø–æ —à–∞–≥–∞–º
**–§–∞–π–ª—ã:** `src/svd/pipeline.rs`
**–ó–∞–≤–∏—Å–∏—Ç –æ—Ç:** –ó–∞–¥–∞—á–∏ 1-3

- [x] 4.1: –°–æ–∑–¥–∞—Ç—å `guidance_scales: Vec<f32>` —Å linspace –ø–æ num_frames –ø–µ—Ä–µ–¥ denoising loop
- [x] 4.2: –í CFG –ª–æ–≥–∏–∫–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Ä–∞–∑–Ω—ã–µ guidance –∫ —Ä–∞–∑–Ω—ã–º —Ñ—Ä–µ–π–º–∞–º —á–µ—Ä–µ–∑ broadcast_mul
- [x] 4.3: –£–±—Ä–∞—Ç—å step-based –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é guidance_scale –∏–∑ —Ü–∏–∫–ª–∞

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü–µ—Ä–≤—ã–π —Ñ—Ä–µ–π–º –ø–æ–ª—É—á–∞–µ—Ç `min_guidance_scale`
- ‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ñ—Ä–µ–π–º –ø–æ–ª—É—á–∞–µ—Ç `max_guidance_scale`
- ‚úÖ –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ñ—Ä–µ–π–º—ã ‚Äî –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è

---

### 5. VAE Decode Chunking ‚úÖ
**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å decode_chunk_size –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è OOM
**–§–∞–π–ª—ã:** `src/svd/vae/mod.rs`, `src/svd/pipeline.rs`, `src/svd/config.rs`
**–ó–∞–≤–∏—Å–∏—Ç –æ—Ç:** –ó–∞–¥–∞—á–∏ 1-4

- [x] 5.1: –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `chunk_size: Option<usize>` –≤ `decode()` –º–µ—Ç–æ–¥
- [x] 5.2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å chunked decode loop –≤ `AutoencoderKLTemporalDecoder::decode`
- [x] 5.3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `decode_chunk_size` –∏–∑ `SvdInferenceConfig` –≤ pipeline
- [x] 5.4: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑—É–º–Ω—ã–π default (Some(2))

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ú–æ–¥–µ–ª—å –Ω–µ –ø–∞–¥–∞–µ—Ç —Å OOM –Ω–∞ 8GB GPU –ø—Ä–∏ 14 —Ñ—Ä–µ–π–º–∞—Ö
- ‚úÖ Output –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –ø—Ä–∏ –ª—é–±–æ–º chunk_size

---

### 6. CFG Batching (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚¨úÔ∏è
**–¶–µ–ª—å:** –û–±—ä–µ–¥–∏–Ω–∏—Ç—å uncond/cond forward passes –≤ –æ–¥–∏–Ω batched call
**–§–∞–π–ª—ã:** `src/svd/pipeline.rs`
**–ó–∞–≤–∏—Å–∏—Ç –æ—Ç:** –ó–∞–¥–∞—á–∏ 1-5

- [ ] 6.1: Concat latents –∏ embeddings –¥–ª—è uncond+cond
- [ ] 6.2: –û–¥–∏–Ω forward pass —á–µ—Ä–µ–∑ UNet
- [ ] 6.3: Split output –Ω–∞ uncond/cond —á–∞—Å—Ç–∏

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- –û–¥–∏–Ω forward pass –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö
- –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–¥–µ–Ω—Ç–∏—á–µ–Ω —Ä–∞–∑–¥–µ–ª—å–Ω—ã–º passes

**–°—Ç–∞—Ç—É—Å:** –û—Ç–ª–æ–∂–µ–Ω–æ ‚Äî –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å

---

### 7. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚¨úÔ∏è
**–¶–µ–ª—å:** –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø–∞—Ä–∏—Ç–µ—Ç–∞ —Å diffusers
**–§–∞–π–ª—ã:** `scripts/compare_with_diffusers.py`, `tests/integration/`
**–ó–∞–≤–∏—Å–∏—Ç –æ—Ç:** –ó–∞–¥–∞—á–∏ 1-5

- [ ] 7.1: –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è intermediate tensors
- [ ] 7.2: –°—Ä–∞–≤–Ω–∏—Ç—å image_embeddings (CLIP output)
- [ ] 7.3: –°—Ä–∞–≤–Ω–∏—Ç—å image_latents (VAE encode output)
- [ ] 7.4: –°—Ä–∞–≤–Ω–∏—Ç—å noise_pred –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
- [ ] 7.5: –°—Ä–∞–≤–Ω–∏—Ç—å final output frames (MSE < threshold)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- MSE –º–µ–∂–¥—É Rust –∏ diffusers output < 1e-3
- –í–∏–∑—É–∞–ª—å–Ω–æ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ —Ñ—Ä–µ–π–º—ã

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –í—ã–ø–æ–ª–Ω–µ–Ω–æ:
1. ‚úÖ **FPS-1 conditioning** ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∏–∫—Å, SVD —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π fps
2. ‚úÖ **Timestep scaling 0.25** ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∏–∫—Å –¥–ª—è v_prediction
3. ‚úÖ **Noise augmentation –≤ pixel space** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç diffusers
4. ‚úÖ **Per-frame guidance scale** ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∏–∫—Å –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
5. ‚úÖ **VAE decode chunking** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç OOM

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `src/svd/pipeline.rs` ‚Äî 4 –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `src/svd/scheduler.rs` ‚Äî 2 –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `src/svd/vae/mod.rs` ‚Äî 1 –∏–∑–º–µ–Ω–µ–Ω–∏–µ
- `src/svd/config.rs` ‚Äî 1 –∏–∑–º–µ–Ω–µ–Ω–∏–µ

### –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–∏–ª—è—Ü–∏–∏:
```
cargo clippy --bin svd --release -- -D warnings
Finished `release` profile [optimized] target(s) in 17.90s
```

## –¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò–∑–º–µ–Ω–µ–Ω–∏—è | –ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª |
|------------------------|-----------|------------------|
| `SvdPipeline::generate()` | FPS, noise aug, guidance | Per-frame guidance |
| `EulerDiscreteScheduler::set_timesteps()` | Timestep scaling | ‚Äî |
| `AutoencoderKLTemporalDecoder::decode()` | ‚Äî | Chunked decode |
| `SvdInferenceConfig` | ‚Äî | decode_chunk_size default |

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–¥–∞—á–∞ | –°—Ç–∞—Ç—É—Å |
|-----------|--------|--------|
| üî¥ P0 | FPS Conditioning | ‚úÖ Done |
| üî¥ P0 | Timestep Scaling | ‚úÖ Done |
| üü† P1 | Noise Augmentation | ‚úÖ Done |
| üü† P1 | Per-Frame Guidance | ‚úÖ Done |
| üü° P2 | Decode Chunking | ‚úÖ Done |
| üü¢ P3 | CFG Batching | ‚¨úÔ∏è Skipped (optional) |
| üü¢ P3 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã | ‚¨úÔ∏è TODO |
